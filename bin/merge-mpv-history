#!/usr/bin/env bash
# merges mpv history files, see:
# https://github.com/seanbreckenridge/mpv-history-daemon#merge

set -o pipefail
set -ex

main() {
	local write_to mpv_dir backup_dir removed_dir
	mpv_dir="$(backup_to mpv)"
	backup_dir="${HOME}/.cache/mpv_removed"
	# backup anything that exists to cache
	rsync -Pavh "${mpv_dir}"/ "$backup_dir"
	# https://github.com/seanbreckenridge/core/blob/main/shellscripts/epoch
	write_to="${mpv_dir}/merged-$(epoch).json"
	mpv-history-daemon merge "${mpv_dir}" --move "${backup_dir}" --write-to "${write_to}" "$@"
	dust "${mpv_dir}"
	# move any previously merged files to a separate directory
	removed_dir="${HOME}/.cache/removed/mpv"
	mkdir -p "$removed_dir"
	mv -v "${backup_dir}"/merged-*.json "${removed_dir}"
	gum spin --title='Checking merged history' -- hpi query my.mpv.history_daemon.history || notify -u critical 'mpv history merge failed'
}

main "$@" || exit $?
