#!/usr/bin/env bash
# runs all bleanser jobs
# if modules are passed as positional args
# filters to only run those jobs

set -o pipefail
set -e

main() {
	local -a filter=("$@")
	local removed_dir="${HOME}/.cache/removed"
	mkdir -p "${removed_dir}"
	for sort_type in size name; do
		prune_module() {
			local module_name module
			local -a args=(--move "${removed_dir}" --yes --sort-by "${sort_type}")
			module_name="${1?pass module name}"
			shift
			module="${module_name}"
			[[ "${module}" == *.* ]] || module="bleanser_sean.modules.${module}"
			if ((${#filter[@]} > 0)); then
				for f in "${filter[@]}"; do
					[[ "$f" == "$module" ]] || {
						printf 'Skipping %s, does not match filter\n' "$module"
						return 0
					}
				done
			fi
			args+=("$@")
			python3 -m "${module}" prune "${args[@]}" || return $?
		}
		prune_module grouvee ~/data/grouvee || return $?
		prune_module zsh ~/data/zsh_history || return $?
		prune_module bash ~/data/bash || return $?
		prune_module bash ~/data/bash_history || return $?
		prune_module ipython ~/data/ipython_default || return $?
		prune_module ipython ~/data/ipython_calculator/ || return $?
		prune_module cstimer ~/data/cubing/cstimer || return $?
		prune_module twistytimer ~/data/cubing/cubers_io || return $?
		prune_module twistytimer ~/data/cubing/phone_twistytimer || return $?
		prune_module smscalls --glob ~/data/SMSBackups/'sms-*' || return $?
		prune_module smscalls --glob ~/data/SMSBackups/'calls-*' || return $?
		prune_module chess --glob ~/data/chess/'chessdotcom_2*' || return $?
		prune_module chess --glob ~/data/chess/'lichess_2*' || return $?
		prune_module trakt --glob ~/data/trakt/'2*' || return $?
		prune_module listenbrainz --glob ~/data/listenbrainz/'2*' || return $?
	done
	dust -c "$removed_dir"
}

main "$@" || exit $?
